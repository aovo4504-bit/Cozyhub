<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>CozyHub Key</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
:root{
  --bg:#050811;
  --card:#071326cc;
  --cyan:#00f0ff;
  --cyan2:#00c6ff;
  --text:#eaf9ff;
  --muted:#a8c7d3;
  --danger:#ff4d6d;
  --ok:#2bff88;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);overflow:hidden}
a{color:inherit;text-decoration:none}
.wrap{position:relative;height:100%;display:flex;align-items:center;justify-content:center;padding:24px}
.bg-canvas{position:absolute;inset:0;z-index:0}
.card{
  position:relative;z-index:2;
  width:min(420px,92vw);
  background:linear-gradient(180deg,#061426ee,#060a14dd);
  border:1px solid rgba(0,240,255,.25);
  border-radius:22px;
  padding:26px 24px 20px;
  box-shadow: 0 0 22px rgba(0,240,255,.16), 0 0 64px rgba(0,240,255,.08);
  backdrop-filter: blur(10px);
}
.logo{
  width:92px;height:92px;border-radius:50%;
  margin:0 auto 10px;
  background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.25), rgba(255,255,255,0) 60%),
              url('https://i.imgur.com/QmY1w3N.png');
  background-size:cover;
  border:1px solid rgba(0,240,255,.32);
  box-shadow:0 0 0 10px rgba(0,240,255,.04), 0 0 28px rgba(0,240,255,.28);
}
.title{
  font-size:34px; font-weight:800; text-align:center; letter-spacing:.3px;
  color:var(--cyan);
  text-shadow:0 0 18px rgba(0,240,255,.35);
}
.sub{
  text-align:center; color:var(--muted);
  margin:10px 6px 18px;
  line-height:1.35;
}
.btn{
  width:100%;
  border:none; cursor:pointer;
  padding:13px 16px;
  border-radius:14px;
  background:linear-gradient(90deg,var(--cyan),var(--cyan2));
  color:#001018;
  font-weight:800;
  letter-spacing:.2px;
  box-shadow:0 0 18px rgba(0,240,255,.22);
  position:relative;
  overflow:hidden;
}
.btn:disabled{opacity:.6; cursor:not-allowed}
.btn::after{
  content:"";
  position:absolute; inset:-60% -40%;
  background:linear-gradient(120deg,rgba(255,255,255,.0),rgba(255,255,255,.35),rgba(255,255,255,0));
  transform:translateX(-60%) rotate(12deg);
  transition:transform .7s ease;
}
.btn:hover::after{transform:translateX(60%) rotate(12deg)}
.row{
  display:flex; gap:10px; margin-top:10px;
}
.pill{
  flex:1;
  border:1px solid rgba(0,240,255,.18);
  background:rgba(0,240,255,.06);
  color:var(--muted);
  border-radius:14px;
  padding:10px 12px;
  font-size:12px;
  text-align:center;
}
.msg{
  margin-top:12px;
  border-radius:14px;
  padding:10px 12px;
  font-size:13px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.06);
  display:none;
}
.msg.show{display:block}
.msg.ok{border-color:rgba(43,255,136,.35); background:rgba(43,255,136,.08)}
.msg.error{border-color:rgba(255,77,109,.35); background:rgba(255,77,109,.08)}
.icons{
  display:flex; gap:14px; justify-content:center;
  margin-top:16px;
}
.iconbtn{
  width:46px;height:46px;border-radius:14px;
  display:flex;align-items:center;justify-content:center;
  background:rgba(0,240,255,.07);
  border:1px solid rgba(0,240,255,.20);
  box-shadow:0 0 16px rgba(0,240,255,.10);
  transition:transform .15s ease, box-shadow .15s ease, background .15s ease;
}
.iconbtn:hover{
  transform:translateY(-2px) scale(1.03);
  box-shadow:0 0 24px rgba(0,240,255,.18);
  background:rgba(0,240,255,.10);
}
.iconbtn img{width:26px;height:26px; filter: drop-shadow(0 0 10px rgba(0,240,255,.25));}
.small{
  text-align:center; font-size:11px; color:rgba(168,199,211,.75);
  margin-top:10px;
}
.kbox{
  margin-top:14px;
  padding:12px 12px;
  border-radius:14px;
  background:rgba(0,0,0,.28);
  border:1px solid rgba(0,240,255,.18);
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  text-align:center;
  user-select:text;
}
.krow{display:flex;gap:10px;margin-top:10px}
.krow .btn{flex:1}
.topbar{
  display:flex;justify-content:space-between;align-items:center;
  gap:10px;margin-bottom:8px
}
.langsel{
  background:rgba(0,240,255,.08);
  border:1px solid rgba(0,240,255,.18);
  color:var(--text);
  border-radius:12px;
  padding:8px 10px;
  font-size:12px;
}
</style>
</head>
<body>
  <canvas id="bg" class="bg-canvas"></canvas>
  <div class="wrap">
    <div class="card">
      <div class="topbar">
        <div style="opacity:.75;font-size:12px">VIP PRO</div>
        <select id="langsel" class="langsel">
          <option value="en">EN</option>
          <option value="vi">VI</option>
          <option value="th">TH</option>
          <option value="id">ID</option>
          <option value="ph">PH</option>
        </select>
      </div>

      <div class="logo"></div>
      <div class="title" id="ttl">CozyHub Key</div>
      <div class="sub" id="subtxt"></div>

      <div class="kbox" id="kbox">...</div>
      <div class="krow">
        <button class="btn" id="copyBtn">Copy</button>
        <button class="btn" id="resetBtn">Reset (24h)</button>
      </div>

      <div class="msg" id="msg"></div>
      <div class="small" id="small"></div>
    </div>
  </div>

<script>
(function(){
  const c=document.getElementById('bg');
  if(!c) return;
  const ctx=c.getContext('2d');
  let w,h,parts=[];
  function resize(){
    w=c.width=window.innerWidth; h=c.height=window.innerHeight;
    parts=Array.from({length:Math.min(140, Math.floor((w*h)/14000))}, ()=>({
      x:Math.random()*w, y:Math.random()*h,
      r:1+Math.random()*2.6,
      vx:(Math.random()-.5)*.35, vy:(Math.random()-.5)*.35,
      a:.15+Math.random()*.35
    }));
  }
  window.addEventListener('resize',resize,{passive:true});
  resize();
  function tick(){
    ctx.clearRect(0,0,w,h);
    // glow dots
    for(const p of parts){
      p.x+=p.vx; p.y+=p.vy;
      if(p.x< -20) p.x=w+20;
      if(p.x>w+20) p.x=-20;
      if(p.y< -20) p.y=h+20;
      if(p.y>h+20) p.y=-20;
      ctx.beginPath();
      ctx.fillStyle=`rgba(0,240,255,${p.a})`;
      ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
      ctx.fill();
    }
    // subtle connections
    for(let i=0;i<parts.length;i++){
      for(let j=i+1;j<parts.length;j++){
        const a=parts[i], b=parts[j];
        const dx=a.x-b.x, dy=a.y-b.y;
        const d=dx*dx+dy*dy;
        if(d<150*150){
          const alpha = 0.06*(1-d/(150*150));
          ctx.strokeStyle=`rgba(0,240,255,${alpha})`;
          ctx.lineWidth=1;
          ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
        }
      }
    }
    requestAnimationFrame(tick);
  }
  tick();
})();
</script>
<script type="module">

const LANGS = ["en","vi","th","id","ph"];
function getLang(){
  const q = new URLSearchParams(location.search);
  const forced = (q.get("lang")||"").toLowerCase();
  if(LANGS.includes(forced)) return forced;
  // default EN always
  return "en";
}
const lang = getLang();
function t(dict){ return dict[lang] ?? dict.en ?? ""; }


const CFG = {
  REALKEY: "https://cozyhub-realkey.aovo4504.workers.dev/",
  VERIFY2_FINISH: "https://cozyhub-verify2.aovo4504.workers.dev/finish"
};

const TEXT={
  sub:{
    en:"Your key is bound to your device (anti-share). Valid for 24 hours.",
    vi:"Key được khóa thiết bị (chống share). Hợp lệ 24 giờ.",
    th:"คีย์ผูกกับอุปกรณ์ (กันแชร์) ใช้ได้ 24 ชม.",
    id:"Key terikat perangkat (anti-share). Berlaku 24 jam.",
    ph:"Naka-bind ang key (anti-share). Valid 24 oras."
  },
  small:{
    en:"If you share your key, it will not work on other devices.",
    vi:"Share key sẽ không chạy trên thiết bị khác.",
    th:"แชร์คีย์จะใช้ไม่ได้บนเครื่องอื่น",
    id:"Jika key dibagikan, tidak akan berfungsi di perangkat lain.",
    ph:"Kapag shinare, hindi gagana sa ibang device."
  },
  copying:{en:"Copied!",vi:"Đã copy!",th:"คัดลอกแล้ว!",id:"Tersalin!",ph:"Nakopya!"},
  loading:{en:"Loading key...",vi:"Đang lấy key...",th:"กำลังโหลดคีย์...",id:"Memuat key...",ph:"Kinukuha ang key..."},
  err:{en:"System error. Please redo missions.",vi:"Lỗi hệ thống. Hãy làm lại nhiệm vụ.",th:"ระบบผิดพลาด โปรดทำภารกิจใหม่",id:"Error. Ulangi misi.",ph:"Error. Ulitin ang missions."},
  reset_ok:{en:"Reset request sent. Please redo missions to get a new key.",vi:"Đã gửi reset. Hãy làm lại nhiệm vụ để lấy key mới.",th:"ส่งคำขอรีเซ็ตแล้ว ทำภารกิจใหม่เพื่อรับคีย์ใหม่",id:"Reset dikirim. Ulangi misi untuk key baru.",ph:"Na-reset. Ulitin missions para sa bagong key."}
};

function setLangUI(){
  document.getElementById("langsel").value = lang;
  document.getElementById("subtxt").textContent = t(TEXT.sub);
  document.getElementById("small").textContent = t(TEXT.small);
}
setLangUI();
document.getElementById("langsel").addEventListener("change",(e)=>{
  const v=e.target.value;
  const q=new URLSearchParams(location.search); q.set("lang", v);
  location.search=q.toString();
});

function show(type, text){
  const m=document.getElementById('msg');
  m.className="msg show " + (type==="error"?"error":"ok");
  m.textContent=text;
}

function getToken2(){
  const q=new URLSearchParams(location.search);
  const fromQ=(q.get("token")||"").trim();
  return fromQ || sessionStorage.getItem("cozy_t2") || "";
}

// Auto-reset missions 10 minutes after a key is issued (hub-like)
const RESET_AFTER_MS = 10 * 60 * 1000;

function applyMissionAutoReset(){
  const resetAt = parseInt(localStorage.getItem("cozy_reset_at") || "0", 10);
  if (resetAt && Date.now() > resetAt) {
    sessionStorage.removeItem("cozy_t1");
    sessionStorage.removeItem("cozy_t2");
    localStorage.removeItem("cozy_reset_at");
  }
}
applyMissionAutoReset();

function markResetWindow(){
  localStorage.setItem("cozy_reset_at", String(Date.now() + RESET_AFTER_MS));
}

async function loadKey(){
  const token=getToken2();
  if(!token){ show("error", t(TEXT.err)); return; }
  document.getElementById("kbox").textContent = t(TEXT.loading);
  try{
    const res=await fetch(CFG.REALKEY, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({ token, hwid:"" })
    });
    const data=await res.json();
    if(!data.ok){
    if(data.code==="KEY_EXPIRED"){
      sessionStorage.removeItem("cozy_t1");
      sessionStorage.removeItem("cozy_t2");
      localStorage.removeItem("cozy_reset_at");
      location.href = "/index.html";
      return;
    }
    throw new Error(data.code||"bad");
  }
    document.getElementById("kbox").textContent = data.key;
    markResetWindow();
    show("ok", "OK • Exp: " + new Date(data.expire).toLocaleString());
  }catch(e){
    console.error(e);
    show("error", t(TEXT.err));
    document.getElementById("kbox").textContent = "ERROR";
  }
}

document.getElementById("copyBtn").addEventListener("click", async ()=>{
  const k=document.getElementById("kbox").textContent.trim();
  if(!k || k==="..." || k==="ERROR") return;
  await navigator.clipboard.writeText(k);
  show("ok", t(TEXT.copying));
});

// reset request = mark key revoked for this fingerprint (admin-like) and force redo missions
document.getElementById("resetBtn").addEventListener("click", async ()=>{
  try{
    const token=getToken2();
    const res=await fetch(CFG.REALKEY+"reset", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({ token })
    });
    const data=await res.json();
    if(!data.ok) throw new Error("bad");
    show("ok", t(TEXT.reset_ok));
    sessionStorage.removeItem("cozy_t1");
    sessionStorage.removeItem("cozy_t2");
  }catch(e){
    console.error(e);
    show("error", t(TEXT.err));
  }
});

loadKey();
</script>
</body>
</html>
