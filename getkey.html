<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CozyHub Key</title>

<style>
    body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: #020817;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        color: white;
        overflow: hidden;
    }
    .stars {
        width: 100%;
        height: 100%;
        position: absolute;
        background: url('https://raw.githubusercontent.com/aovo4504-bit/Cozyhub/main/starsbg.gif');
        background-size: cover;
        z-index: -1;
    }
    .card {
        background: rgba(0,0,0,0.55);
        padding: 35px;
        width: 360px;
        border-radius: 20px;
        text-align: center;
        box-shadow: 0 0 45px #00eaff;
    }
    h1 {
        color: #00eaff;
        text-shadow: 0 0 13px #00eaff;
        margin-bottom: 18px;
    }
    .loader {
        border: 5px solid #0e1e28;
        border-top: 5px solid #00eaff;
        border-radius: 50%;
        width: 45px;
        height: 45px;
        margin: 0 auto 12px;
        animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg);} }

    .progress-box {
        margin-top: 5px;
        background: #0e1e28;
        height: 12px;
        border-radius: 10px;
        overflow: hidden;
    }
    .progress {
        background: #00eaff;
        height: 100%;
        width: 0%;
        animation: load 3s forwards;
        box-shadow: 0 0 20px #00eaff;
    }
    @keyframes load { 100% { width: 100%; } }

    .status-text {
        margin-top: 10px;
        font-size: 14px;
    }

    .keybox {
        margin-top: 15px;
        padding: 12px;
        background: #000;
        border-radius: 12px;
        box-shadow: inset 0 0 25px #00eaff;
        font-size: 18px;
        word-break: break-all;
        min-height: 24px;
    }
    .keybox.error {
        box-shadow: inset 0 0 20px #ff4d4d;
        color: #ff4d4d;
    }

    .copy-btn {
        margin-top: 15px;
        background: #00eaff;
        padding: 12px;
        border-radius: 10px;
        width: 100%;
        border: none;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 0 25px #00eaff;
    }
    .copy-btn:active {
        transform: scale(0.98);
    }

    .msg {
        margin-top: 10px;
        color: #59ff91;
        display: none;
        font-size: 14px;
    }
    .msg.error {
        color: #ff4d4d;
        text-shadow: 0 0 10px #ff4d4d;
    }
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyA0NQVV4puksa_QzcqtQuQNCjmc_B9OIf4",
  authDomain: "cozyhubkey.firebaseapp.com",
  databaseURL: "https://cozyhubkey-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "cozyhubkey",
  storageBucket: "cozyhubkey.appspot.com",
  messagingSenderId: "1081463631644",
  appId: "1:1081463631644:web:92c15e4b94375ecf1554d9",
  measurementId: "G-3JHJV6ZR4J"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ====== CẤU HÌNH TOKEN BẢO MẬT ======
const REAL_TOKEN = "COZYHUB_9d8293f2c18c4f0b9df3";  // phải trùng y chang trong Link4m
// ====================================

function generateKey() {
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
    let k = "";
    for (let i = 0; i < 40; i++) {
        k += chars[Math.floor(Math.random() * chars.length)];
    }
    return k;
}

async function main() {
    const params = new URLSearchParams(window.location.search);

    // lấy token từ URL, ưu tiên ?token=..., rồi mới tới ?code=... (cho chắc)
    let token = params.get("token") || params.get("code") || "";
    token = token.trim();  // bỏ khoảng trắng thừa

    const keyBox = document.getElementById("key");
    const msg = document.getElementById("msg");
    const status = document.getElementById("status");

    // Nếu token sai -> báo chưa làm nhiệm vụ
    if (token !== REAL_TOKEN) {
        status.textContent = "Đang xử lý nhiệm vụ...";
        // đợi animation 3s cho đẹp rồi mới báo lỗi
        setTimeout(() => {
            keyBox.classList.add("error");
            keyBox.textContent = "Bạn chưa làm nhiệm vụ!";
            msg.classList.add("error");
            msg.textContent = "Hãy quay lại Link4m để làm nhiệm vụ.";
            msg.style.display = "block";
        }, 3000);
        return;
    }

    // Đúng token -> xử lý tạo / lấy key
    setTimeout(async () => {
        try {
            status.textContent = "Đang kiểm tra key...";

            const ip = await fetch("https://api.ipify.org?format=json")
                .then(r => r.json())
                .then(d => d.ip);

            const ipRef = ref(db, "ips/" + ip);
            const snap = await get(ipRef);
            const now = Date.now();

            // Nếu IP đã có key còn hạn -> dùng lại, không tạo mới
            if (snap.exists() && snap.val().expire > now) {
                const savedKey = snap.val().key;
                keyBox.textContent = savedKey;
                msg.textContent = "Bạn đã lấy key rồi (còn hạn).";
                msg.classList.remove("error");
                msg.style.display = "block";
                status.textContent = "Hoàn tất.";
                return;
            }

            // Tạo key mới
            const key = generateKey();
            const expire = now + 24 * 60 * 60 * 1000; // 24h

            await set(ref(db, "ips/" + ip), {
                key: key,
                expire: expire
            });

            await set(ref(db, "keys/" + key), {
                key: key,
                expire: expire,
                used: false,
                ip: ip
            });

            keyBox.textContent = key;
            msg.textContent = "Key có hiệu lực 24h và chỉ dùng được 1 lần!";
            msg.classList.remove("error");
            msg.style.display = "block";
            status.textContent = "Hoàn tất.";
        } catch (e) {
            console.error(e);
            keyBox.classList.add("error");
            keyBox.textContent = "Lỗi hệ thống, thử lại sau.";
            msg.classList.add("error");
            msg.textContent = "Không lấy được key, có thể lỗi mạng hoặc Firebase.";
            msg.style.display = "block";
            status.textContent = "Lỗi.";
        }
    }, 3000);
}

main();

window.copyKey = function () {
    const key = document.getElementById("key").innerText.trim();
    if (!key || key === "...") return;

    navigator.clipboard.writeText(key).then(() => {
        const msg = document.getElementById("msg");
        msg.classList.remove("error");
        msg.textContent = "Đã copy Key!";
        msg.style.display = "block";
    });
}
</script>

</head>
<body>

<div class="stars"></div>

<div class="card">

    <h1>CozyHub Key</h1>

    <div id="loadingBox">
        <div class="loader"></div>
        <div class="progress-box"><div class="progress"></div></div>
        <p class="status-text" id="status">Đang xử lý nhiệm vụ...</p>
    </div>

    <div id="keyBox">
        <div class="keybox" id="key">...</div>
        <button class="copy-btn" onclick="copyKey()">COPY KEY</button>
        <div class="msg" id="msg"></div>
    </div>

</div>

</body>
</html>
