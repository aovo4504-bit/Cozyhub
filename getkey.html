<script type="module">
/* ====== language (EN default) ====== */
const langRaw=(navigator.language||"en").toLowerCase();
const LANG = (langRaw.startsWith("vi")?"vi":langRaw.startsWith("th")?"th":langRaw.startsWith("id")?"id":(langRaw.startsWith("fil")||langRaw.startsWith("ph")||langRaw.startsWith("tl"))?"ph":"en");

const TEXT={
  need_both:{en:"You must complete both missions before getting the key.",vi:"Bạn phải hoàn thành cả 2 nhiệm vụ trước khi nhận key.",th:"คุณต้องทำทั้งสองภารกิจให้เสร็จก่อนรับคีย์",id:"Anda harus menyelesaikan kedua misi sebelum mendapatkan key.",ph:"Kailangan mong tapusin ang dalawang tasks bago makuha ang key."},
  err:{en:"System error. Try again.",vi:"Lỗi hệ thống. Thử lại.",th:"ระบบผิดพลาด ลองใหม่",id:"Error sistem. Coba lagi.",ph:"System error. Subukan ulit."},
  copied:{en:"Key copied!",vi:"Đã copy key!",th:"คัดลอกคีย์แล้ว!",id:"Key disalin!",ph:"Nakopya na ang key!"},
  ok24:{en:"Key is valid for 24 hours.",vi:"Key hợp lệ trong 24 giờ.",th:"คีย์ใช้ได้ 24 ชั่วโมง",id:"Key berlaku selama 24 jam.",ph:"Valid ang key sa loob ng 24 oras."}
};

// HARD BLOCK bypass (web layer)
const ok = localStorage.getItem("cozy_task1")==="done" && localStorage.getItem("cozy_task2")==="done";
if(!ok){
  document.body.innerHTML = `<div style="display:flex;justify-content:center;align-items:center;height:100vh;background:#050811;color:#fff;font-family:Poppins,system-ui,sans-serif;text-align:center;padding:20px;">
    <h2>${TEXT.need_both[LANG]}</h2>
  </div>`;
  throw new Error("Not finished missions");
}

// call realkey (server anti-share)
const params=new URLSearchParams(location.search);
const token=(params.get("token")||params.get("code")||"").trim();

const statusEl=document.getElementById("status");
const msgEl=document.getElementById("msg");
const keyEl=document.getElementById("key");
const copyBtn=document.getElementById("copy");
const loader=document.getElementById("loader");
const timeLeftEl=document.getElementById("time-left");

function setMsg(ok, text){
  if(!msgEl) return;
  msgEl.className="msg show " + (ok?"ok":"error");
  msgEl.textContent=text;
}
function fmt(ms){
  if(ms<=0) return "expired";
  const s=Math.floor(ms/1000), h=Math.floor(s/3600), m=Math.floor((s%3600)/60);
  return (LANG==="vi")?`Còn lại: ${h} giờ ${m} phút`:`Time left: ${h}h ${m}m`;
}

async function run(){
  if(statusEl) statusEl.textContent="Contacting server...";
  try{
    const res=await fetch("https://cozyhub-realkey.aovo4504.workers.dev/",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ token })
    });
    const data=await res.json();
    if(!data.ok) throw 0;

    keyEl.textContent=data.key;
    keyEl.classList.add("show");
    copyBtn.classList.add("show");
    loader?.classList.add("done");

    setMsg(true, TEXT.ok24[LANG]);
    if(statusEl) statusEl.textContent="Done.";

    const tick=()=>{
      const left=data.expire - Date.now();
      if(timeLeftEl) timeLeftEl.textContent=fmt(left);
    };
    tick(); setInterval(tick, 60000);

  }catch(e){
    loader?.classList.add("done");
    setMsg(false, TEXT.err[LANG]);
    if(statusEl) statusEl.textContent="Done.";
  }
}
run();

window.copyKey = async function(){
  const k=(keyEl?.innerText||"").trim();
  if(!k) return;
  await navigator.clipboard.writeText(k);
  setMsg(true, TEXT.copied[LANG]);
};
</script>
