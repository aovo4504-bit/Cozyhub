<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CozyHub Key</title>

<style>
    body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: #020817;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        color: white;
        overflow: hidden;
    }

    /* NỀN VŨ TRỤ */
    #universe {
        position: fixed;
        inset: 0;
        width: 100vw;
        height: 100vh;
        z-index: -1;
    }

    /* CARD */
    .card {
        background: rgba(0,0,0,0.55);
        padding: 40px;
        width: 420px;
        border-radius: 22px;
        text-align: center;
        box-shadow: 0 0 55px #00eaff;
    }

    h1 {
        color: #00eaff;
        text-shadow: 0 0 15px #00eaff;
        margin-bottom: 20px;
        font-size: 30px;
    }

    .loader {
        border: 6px solid #0e1e28;
        border-top: 6px solid #00eaff;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        margin: 0 auto 12px;
        animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg);} }

    .progress-box {
        margin-top: 5px;
        background: #0e1e28;
        height: 12px;
        border-radius: 10px;
        overflow: hidden;
    }

    .progress {
        background: #00eaff;
        height: 100%;
        width: 0%;
        animation: load 3s forwards;
        box-shadow: 0 0 25px #00eaff;
    }
    @keyframes load { 100% { width: 100%; } }

    .status-text {
        margin-top: 12px;
        font-size: 15px;
    }

    .keybox {
        margin-top: 18px;
        padding: 14px;
        background: #000;
        border-radius: 12px;
        box-shadow: inset 0 0 25px #00eaff;
        font-size: 20px;
        min-height: 26px;
        word-break: break-all;
    }
    .keybox.error {
        box-shadow: inset 0 0 22px #ff4d4d;
        color: #ff4d4d;
    }

    .copy-btn {
        margin-top: 15px;
        background: #00eaff;
        padding: 14px;
        border-radius: 10px;
        width: 100%;
        border: none;
        font-weight: bold;
        font-size: 16px;
        cursor: pointer;
        box-shadow: 0 0 30px #00eaff;
    }

    .msg {
        margin-top: 12px;
        color: #59ff91;
        display: none;
        font-size: 14px;
    }
    .msg.error {
        color: #ff4d4d;
        text-shadow: 0 0 10px #ff4d4d;
    }
</style>

<!-- FIREBASE SCRIPT -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyA0NQVV4puksa_QzcqtQuQNCjmc_B9OIf4",
  authDomain: "cozyhubkey.firebaseapp.com",
  databaseURL: "https://cozyhubkey-default-rtdb.asia-southeast1.firebasedatabase.app/",
  projectId: "cozyhubkey",
  storageBucket: "cozyhubkey.appspot.com",
  messagingSenderId: "1081463631644",
  appId: "1:1081463631644:web:92c15e4b94375ecf1554d9"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const REAL_TOKEN = "COZYHUB_9d8293f2c18c4f0b9df3";

function generateKey() {
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
    let k = "";
    for (let i = 0; i < 40; i++) k += chars[Math.floor(Math.random() * chars.length)];
    return k;
}

async function main() {
    const params = new URLSearchParams(window.location.search);
    let token = (params.get("token") || params.get("code") || "").trim();

    const keyBox = document.getElementById("key");
    const msg = document.getElementById("msg");
    const status = document.getElementById("status");

    if (token !== REAL_TOKEN) {
        setTimeout(() => {
            keyBox.classList.add("error");
            keyBox.textContent = "Bạn chưa làm nhiệm vụ!";
            msg.classList.add("error");
            msg.textContent = "Hãy quay lại Link4m để làm nhiệm vụ.";
            msg.style.display = "block";
        }, 3000);
        return;
    }

    setTimeout(async () => {
        try {
            status.textContent = "Đang kiểm tra key...";

            const ip = await fetch("https://api.ipify.org?format=json").then(r => r.json()).then(d => d.ip);
            const safeIP = ip.replace(/\./g, "_");

            const ipRef = ref(db, "ips/" + safeIP);

            let snap = await get(ipRef).catch(() => null);
            const now = Date.now();

            if (snap && snap.exists() && snap.val().expire > now) {
                const oldKey = snap.val().key || null;

                if (oldKey) {
                    keyBox.textContent = oldKey;
                    msg.textContent = "Bạn đã lấy key rồi (còn hạn).";
                    msg.style.display = "block";
                    status.textContent = "Hoàn tất.";
                    return;
                }
            }

            const key = generateKey();
            const expire = now + 24 * 60 * 60 * 1000;

            await set(ipRef, { key, expire });

            await set(ref(db, "keys/" + key), {
                expire: expire,
                used: false,
                ip: safeIP
            });

            keyBox.textContent = key;
            msg.textContent = "Key mới tạo – có hạn 24h.";
            msg.style.display = "block";
            status.textContent = "Hoàn tất.";

        } catch (err) {
            keyBox.classList.add("error");
            keyBox.textContent = "Lỗi hệ thống!";
            msg.classList.add("error");
            msg.textContent = "Không lấy được key.";
            msg.style.display = "block";
            status.textContent = "Lỗi.";
        }
    }, 3000);
}

main();

window.copyKey = function () {
    const key = document.getElementById("key").innerText.trim();
    if (!key || key === "...") return;

    navigator.clipboard.writeText(key).then(() => {
        const msg = document.getElementById("msg");
        msg.classList.remove("error");
        msg.textContent = "Đã copy Key!";
        msg.style.display = "block";
    });
}
</script>

</head>
<body>

<canvas id="universe"></canvas>

<div class="card">
    <h1>CozyHub Key</h1>

    <div id="loadingBox">
        <div class="loader"></div>
        <div class="progress-box"><div class="progress"></div></div>
        <p class="status-text" id="status">Đang xử lý nhiệm vụ...</p>
    </div>

    <div id="keyBox">
        <div class="keybox" id="key">...</div>
        <button class="copy-btn" onclick="copyKey()">COPY KEY</button>
        <div class="msg" id="msg"></div>
    </div>
</div>

<!-- SCRIPT NỀN VŨ TRỤ -->
<script>
const canvas = document.getElementById('universe');
const ctx = canvas.getContext('2d');

let w, h;
function resize() {
    w = canvas.width = window.innerWidth;
    h = canvas.height = window.innerHeight;
}
resize();
window.addEventListener("resize", resize);

let stars = [];
let count = 350;

for (let i = 0; i < count; i++) {
    stars.push({
        x: Math.random() * w,
        y: Math.random() * h,
        z: Math.random() * 3 + 1
    });
}

function animate() {
    ctx.clearRect(0, 0, w, h);
    ctx.fillStyle = "white";

    for (let s of stars) {
        let speed = s.z * 0.7;

        s.y += speed;
        if (s.y > h) {
            s.y = 0; s.x = Math.random() * w;
        }

        ctx.beginPath();
        ctx.arc(s.x, s.y, s.z, 0, Math.PI * 2);
        ctx.fill();
    }

    requestAnimationFrame(animate);
}
animate();
</script>

</body>
</html>
