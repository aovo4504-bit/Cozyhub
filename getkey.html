<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CozyHub Key</title>

<style>
    body {
        margin: 0;
        font-family: 'Poppins', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        background: #050811;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
        color: #ffffff;
    }

    /* nền nhẹ, không màu mè */
    .bg {
        position: fixed;
        inset: 0;
        background:
            radial-gradient(circle at top, #151b2b 0, #050811 55%, #02040a 100%);
        z-index: -2;
    }

    .card {
        width: 430px;
        max-width: 92vw;
        background: rgba(7, 11, 20, 0.92);
        padding: 34px 30px 30px;
        border-radius: 26px;
        text-align: center;
        box-shadow:
            0 0 45px rgba(0, 255, 255, 0.25),
            0 0 90px rgba(0, 255, 255, 0.12);
        border: 1px solid rgba(0,255,255,0.25);
    }

    .logo {
        width: 110px;
        height: 110px;
        margin: 0 auto 16px;
        border-radius: 50%;
        background: url('https://raw.githubusercontent.com/aovo4504-bit/Cozyhub/refs/heads/main/IMG_0830.png')
            center/cover;
        box-shadow:
            0 0 18px #00eaff,
            0 0 40px rgba(0,255,255,0.7);
    }

    h1 {
        font-size: 32px;
        margin: 6px 0 18px;
        color: #00eaff;
        letter-spacing: 0.5px;
        text-shadow:
            0 0 10px rgba(0,255,255,0.6),
            0 0 18px rgba(0,255,255,0.35);
    }

    .loader-wrap {
        margin-top: 4px;
        margin-bottom: 14px;
        height: 56px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .loader {
        border: 5px solid #18202c;
        border-top: 5px solid #00eaff;
        width: 46px;
        height: 46px;
        border-radius: 50%;
        animation: spin 1.1s linear infinite;
    }

    .loader.done {
        border-color: transparent;
        border-top-color: transparent;
        background: none;
        position: relative;
    }

    /* icon check sau khi có key */
    .loader.done::before {
        content: "✓";
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 30px;
        color: #00ff9d;
        text-shadow: 0 0 14px rgba(0,255,157,0.85);
    }

    @keyframes spin { to { transform: rotate(360deg);} }

    .status {
        margin-top: 4px;
        font-size: 14px;
        opacity: 0.8;
    }

    .keybox {
        margin-top: 22px;
        padding: 13px 14px;
        border-radius: 12px;
        background: rgba(0, 0, 0, 0.7);
        font-size: 18px;
        min-height: 26px;
        letter-spacing: 1px;
        text-align: center;
        border: 1px solid rgba(0,255,255,0.4);
        box-shadow: inset 0 0 22px rgba(0,255,255,0.35);
        transition: 0.28s ease;
        opacity: 0;
        transform: translateY(8px);
        word-break: break-all;
    }
    .keybox.show { opacity: 1; transform: translateY(0); }

    .time-left {
        margin-top: 10px;
        font-size: 13px;
        opacity: 0.85;
    }

    .copy-btn {
        margin-top: 18px;
        padding: 12px 0;
        width: 100%;
        font-weight: 600;
        border-radius: 10px;
        border: none;
        cursor: pointer;
        background: #00eaff;
        color: #001015;
        font-size: 16px;
        box-shadow: 0 0 24px rgba(0,255,255,0.5);
        transition: 0.22s;
        opacity: 0;
        transform: translateY(8px);
    }
    .copy-btn.show { opacity: 1; transform: translateY(0); }
    .copy-btn:hover { transform: translateY(0) scale(1.03); }

    .msg {
        margin-top: 10px;
        font-size: 13px;
        opacity: 0;
        transition: 0.25s;
    }
    .msg.show { opacity: 1; }

    .msg.ok { color: #78ff9f; }
    .msg.error { color: #ff5b5b; }

    .small {
        margin-top: 6px;
        font-size: 11px;
        opacity: 0.5;
    }
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, get, set, update } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

/* ======================
   AUTO LANG (VI / EN)
====================== */
const lang = (navigator.language || "en").toLowerCase().startsWith("vi") ? "vi" : "en";

const TEXT = {
    title: { vi: "CozyHub Key", en: "CozyHub Key" },
    processing: { vi: "Đang xử lý...", en: "Processing..." },
    checking:   { vi: "Đang kiểm tra key...", en: "Checking key..." },
    done:       { vi: "Hoàn tất.", en: "Done." },

    access_denied: {
        vi: "Bạn chưa làm nhiệm vụ (token không hợp lệ).",
        en: "You haven't completed the task (invalid token)."
    },
    rate_limit: {
        vi: "Bạn thao tác quá nhanh, thử lại sau ít phút.",
        en: "You are doing this too fast, please try again later."
    },
    banned: {
        vi: "IP của bạn tạm thời bị chặn do nghi ngờ spam.",
        en: "Your IP is temporarily blocked due to suspected abuse."
    },
    already_taken: {
        vi: "Bạn đã lấy key rồi.",
        en: "You already claimed a key."
    },
    key_valid_24h: {
        vi: "Key hợp lệ trong 24 giờ.",
        en: "Key is valid for 24 hours."
    },
    system_error: {
        vi: "Lỗi hệ thống, hãy thử lại sau.",
        en: "System error, please try again later."
    },
    copied: {
        vi: "Đã copy key!",
        en: "Key copied!"
    },
    time_left_prefix: {
        vi: "Còn lại:",
        en: "Time left:"
    }
};

/* ======================
       FIREBASE CONFIG
====================== */
const firebaseConfig = {
  apiKey: "AIzaSyA0NQVV4puksa_QzcqtQuQNCjmc_B9OIf4",
  authDomain: "cozyhubkey.firebaseapp.com",
  databaseURL: "https://cozyhubkey-default-rtdb.asia-southeast1.firebasedatabase.app/",
  projectId: "cozyhubkey",
  storageBucket: "cozyhubkey.appspot.com",
  messagingSenderId: "1081463631644",
  appId: "1:1081463631644:web:92c15e4b94375ecf1554d9"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* TOKEN từ Link4m – nhớ set giống trên Link4m */
const REAL_TOKEN = "COZYHUB_9d8293f2c18c4f0b9df3";

/* ========== Utility ========== */
function setStatus(textKey) {
    document.getElementById("status").textContent = TEXT[textKey][lang];
}

function setMsg(type, textKey) {
    const msg = document.getElementById("msg");
    msg.className = "msg show " + (type === "error" ? "error" : "ok");
    msg.textContent = TEXT[textKey][lang];
}

function formatRemaining(ms) {
    if (ms <= 0) return lang === "vi" ? "hết hạn" : "expired";
    const totalSec = Math.floor(ms / 1000);
    const h = Math.floor(totalSec / 3600);
    const m = Math.floor((totalSec % 3600) / 60);
    if (lang === "vi") {
        return `${TEXT.time_left_prefix[lang]} ${h} giờ ${m} phút`;
    } else {
        return `${TEXT.time_left_prefix[lang]} ${h}h ${m}m`;
    }
}

/*  KEY FORMAT: XXXX-XXXX-XXXX-XXXX */
function generateKey() {
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
    let raw = "";
    for (let i = 0; i < 16; i++) {
        raw += chars[Math.floor(Math.random() * chars.length)];
    }
    return `${raw.slice(0,4)}-${raw.slice(4,8)}-${raw.slice(8,12)}-${raw.slice(12,16)}`;
}

/* SHA-256 cho việc lưu HASH như hub lớn */
async function sha256(str) {
    const buf = new TextEncoder().encode(str);
    const hash = await crypto.subtle.digest("SHA-256", buf);
    return Array.from(new Uint8Array(hash))
        .map(b => b.toString(16).padStart(2, "0"))
        .join("");
}

/* ========== MAIN LOGIC ========== */
async function main() {
    document.getElementById("title").textContent = TEXT.title[lang];
    setStatus("processing");

    const params = new URLSearchParams(window.location.search);
    const token = (params.get("token") || params.get("code") || "").trim();

    const keyBox = document.getElementById("key");
    const copyBtn = document.getElementById("copy");
    const loader = document.getElementById("loader");
    const timeLeftEl = document.getElementById("time-left");

    // 1) Token sai => chưa làm nhiệm vụ
    if (token !== REAL_TOKEN) {
        setTimeout(() => {
            loader.classList.add("done");
            keyBox.textContent = "ACCESS DENIED";
            keyBox.classList.add("show");
            setMsg("error", "access_denied");
            setStatus("done");
        }, 2000);
        return;
    }

    setTimeout(async () => {
        try {
            setStatus("checking");

            // 2) Lấy IP & userAgent (dùng cho chống spam)
            const ip = await fetch("https://api.ipify.org?format=json")
                .then(r => r.json())
                .then(d => d.ip);
            const safeIP = ip.replace(/\./g, "_");
            const ua = navigator.userAgent || "unknown";

            // 3) Chống spam rất đơn giản
            const metaRef = ref(db, "meta/" + safeIP);
            const metaSnap = await get(metaRef);
            const now = Date.now();

            if (metaSnap.exists()) {
                const meta = metaSnap.val();
                // nếu đang bị ban
                if (meta.bannedUntil && meta.bannedUntil > now) {
                    loader.classList.add("done");
                    keyBox.textContent = "BLOCKED";
                    keyBox.classList.add("show");
                    setMsg("error", "banned");
                    setStatus("done");
                    return;
                }

                // nếu request quá nhanh trong 10s
                if (meta.lastReq && now - meta.lastReq < 10 * 1000) {
                    loader.classList.add("done");
                    keyBox.textContent = "RATE LIMIT";
                    keyBox.classList.add("show");
                    setMsg("error", "rate_limit");

                    // tăng điểm nghi ngờ
                    const strikes = (meta.strikes || 0) + 1;
                    let bannedUntil = meta.bannedUntil || 0;
                    if (strikes >= 5) {
                        bannedUntil = now + 30 * 60 * 1000; // ban 30 phút
                    }
                    await update(metaRef, {
                        lastReq: now,
                        strikes,
                        bannedUntil
                    });
                    setStatus("done");
                    return;
                }

                // update time nhưng reset điểm nhẹ
                await update(metaRef, {
                    lastReq: now,
                    ua
                });
            } else {
                await set(metaRef, {
                    lastReq: now,
                    strikes: 0,
                    bannedUntil: 0,
                    ua
                });
            }

            // 4) kiểm tra key theo IP
            const ipRef = ref(db, "ips/" + safeIP);
            const ipSnap = await get(ipRef);

            let expire, key, keyHash;

            if (ipSnap.exists() && ipSnap.val().expire > now) {
                // đã có key còn hạn
                const data = ipSnap.val();
                key = data.key;
                expire = data.expire;
                keyHash = data.hash; // có cũng được, không có cũng được

                keyBox.textContent = key;
                keyBox.classList.add("show");
                copyBtn.classList.add("show");
                setMsg("ok", "already_taken");
            } else {
                // 5) tạo key mới
                key = generateKey();
                expire = now + 24 * 60 * 60 * 1000;  // 24h
                keyHash = await sha256(key);

                // lưu theo IP (cho user xem key cũ)
                await set(ipRef, {
                    key,
                    hash: keyHash,
                    expire
                });

                // lưu theo HASH (giống Delta/HohoHub)
                await set(ref(db, "keys/" + keyHash), {
                    hash: keyHash,
                    expire,
                    used: false,
                    ip: safeIP
                    // HWID sẽ được bind lần đầu bên Roblox script
                });

                keyBox.textContent = key;
                keyBox.classList.add("show");
                copyBtn.classList.add("show");
                setMsg("ok", "key_valid_24h");
            }

            // loader -> check icon
            loader.classList.add("done");
            setStatus("done");

            // 6) hiển thị đếm ngược thời gian còn lại
            function updateRemaining() {
                const left = expire - Date.now();
                timeLeftEl.textContent = formatRemaining(left);
                if (left <= 0) {
                    clearInterval(timer);
                }
            }
            updateRemaining();
            const timer = setInterval(updateRemaining, 60 * 1000);

        } catch (e) {
            console.error(e);
            loader.classList.add("done");
            keyBox.textContent = "ERROR";
            keyBox.classList.add("show");
            setMsg("error", "system_error");
            setStatus("done");
        }
    }, 2200);
}

main();

window.copyKey = function () {
    const key = document.getElementById("key").innerText.trim();
    if (!key || key === "..." || key === "ERROR" || key === "ACCESS DENIED" || key === "RATE LIMIT" || key === "BLOCKED") return;

    navigator.clipboard.writeText(key).then(() => {
        const msg = document.getElementById("msg");
        msg.className = "msg show ok";
        msg.textContent = TEXT.copied[lang];
    });
};
</script>
</head>
<body>

<div class="bg"></div>

<div class="card">
    <div class="logo"></div>
    <h1 id="title">CozyHub Key</h1>

    <div class="loader-wrap">
        <div id="loader" class="loader"></div>
    </div>
    <div id="status" class="status">Processing...</div>

    <div id="key" class="keybox">...</div>
    <div id="time-left" class="time-left"></div>
    <button id="copy" class="copy-btn" onclick="copyKey()">COPY</button>
    <div id="msg" class="msg"></div>
    <div class="small">One key per IP / 24h</div>
</div>

</body>
</html>
