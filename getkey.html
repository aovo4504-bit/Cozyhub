<script type="module">
/* ====== auto lang ====== */
let langRaw = (navigator.language || "en").toLowerCase();
let lang;
if (langRaw.startsWith("vi")) lang = "vi";
else if (langRaw.startsWith("th")) lang = "th";
else if (langRaw.startsWith("id")) lang = "id";
else if (langRaw.startsWith("fil") || langRaw.startsWith("ph") || langRaw.startsWith("tl")) lang = "ph";
else lang = "en";

const TEXT = {
  title: { vi:"CozyHub Key", en:"CozyHub Key", th:"CozyHub Key", id:"CozyHub Key", ph:"CozyHub Key" },
  processing: {
    vi:"Đang xử lý...",
    en:"Processing...",
    th:"กำลังประมวลผล...",
    id:"Sedang memproses...",
    ph:"Nagpro-process..."
  },
  checking: {
    vi:"Đang gọi máy chủ...",
    en:"Contacting server...",
    th:"กำลังติดต่อเซิร์ฟเวอร์...",
    id:"Menghubungi server...",
    ph:"Kinokontak ang server..."
  },
  done: {
    vi:"Hoàn tất.",
    en:"Done.",
    th:"เสร็จสิ้น",
    id:"Selesai.",
    ph:"Tapos na."
  },
  need_both_tasks: {
    vi:"Bạn phải hoàn thành cả 2 nhiệm vụ trước khi nhận key.",
    en:"You must complete both missions before getting the key.",
    th:"คุณต้องทำทั้งสองภารกิจให้เสร็จก่อนรับคีย์",
    id:"Anda harus menyelesaikan kedua misi sebelum mendapatkan key.",
    ph:"Kailangan mong tapusin ang dalawang tasks bago makuha ang key."
  },
  system_error: {
    vi:"Lỗi hệ thống, hãy thử lại sau.",
    en:"System error, please try again later.",
    th:"เกิดข้อผิดพลาดของระบบ กรุณาลองใหม่ภายหลัง",
    id:"Terjadi kesalahan sistem, coba lagi nanti.",
    ph:"System error, subukan ulit mamaya."
  },
  copied: {
    vi:"Đã copy key!",
    en:"Key copied!",
    th:"คัดลอกคีย์แล้ว!",
    id:"Key disalin!",
    ph:"Nakopya na ang key!"
  },
  already_taken: {
    vi:"Bạn đã lấy key rồi (hiện lại key cũ).",
    en:"You already claimed a key (showing existing key).",
    th:"คุณรับคีย์ไปแล้ว (แสดงคีย์เดิม)",
    id:"Anda sudah mengambil key (menampilkan key lama).",
    ph:"Nakuha mo na ang key (inuulit lang ang lumang key)."
  },
  key_valid_24h: {
    vi:"Key hợp lệ trong 24 giờ.",
    en:"Key is valid for 24 hours.",
    th:"คีย์ใช้ได้ 24 ชั่วโมง",
    id:"Key berlaku selama 24 jam.",
    ph:"Valid ang key sa loob ng 24 oras."
  },
  time_left_prefix: {
    vi:"Còn lại:",
    en:"Time left:",
    th:"คงเหลือ:",
    id:"Sisa waktu:",
    ph:"Oras na natitira:"
  }
};

function setStatus(k){ const el=document.getElementById("status"); if(el) el.textContent=TEXT[k][lang]; }

function setMsg(type, textKey){
  const msg = document.getElementById("msg");
  msg.className = "msg show " + (type === "error" ? "error" : "ok");
  msg.textContent = TEXT[textKey][lang];
}

function formatRemaining(ms){
  if (ms <= 0) return "expired";
  const totalSec = Math.floor(ms / 1000);
  const h = Math.floor(totalSec / 3600);
  const m = Math.floor((totalSec % 3600) / 60);
  if (lang === "vi") return `${TEXT.time_left_prefix[lang]} ${h} giờ ${m} phút`;
  if (lang === "th") return `${TEXT.time_left_prefix[lang]} ${h} ชม. ${m} นาที`;
  if (lang === "id") return `${TEXT.time_left_prefix[lang]} ${h} jam ${m} menit`;
  if (lang === "ph") return `${TEXT.time_left_prefix[lang]} ${h}h ${m}m`;
  return `${TEXT.time_left_prefix[lang]} ${h}h ${m}m`;
}

/* ====== CHẶN X2 NHIỆM VỤ ====== */
const tasksOK =
  localStorage.getItem("cozy_task1") === "done" &&
  localStorage.getItem("cozy_task2") === "done";

if (!tasksOK) {
  document.addEventListener("DOMContentLoaded", () => {
    document.body.innerHTML = `
      <div style="display:flex;justify-content:center;align-items:center;height:100vh;background:#050811;color:#fff;font-family:'Poppins',system-ui,sans-serif;text-align:center;padding:20px;">
        <h2>${TEXT.need_both_tasks[lang]}</h2>
      </div>`;
  });
} else {
  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("title").textContent = TEXT.title[lang];
    setStatus("processing");
    runGetKey();
  });
}

async function runGetKey(){
  const loader = document.getElementById("loader");
  const keyBox = document.getElementById("key");
  const copyBtn = document.getElementById("copy");
  const timeLeftEl = document.getElementById("time-left");

  keyBox.textContent = "...";
  keyBox.classList.remove("show");
  copyBtn.classList.remove("show");
  loader.classList.remove("done");

  const params = new URLSearchParams(location.search);
  const token = (params.get("token") || params.get("code") || "").trim();

  if (!token){
    loader.classList.add("done");
    keyBox.textContent = "NO TOKEN";
    keyBox.classList.add("show");
    setMsg("error","system_error");
    setStatus("done");
    return;
  }

  setTimeout(async () => {
    try{
      setStatus("checking");

      const res = await fetch("https://cozyhub-realkey.aovo4504.workers.dev/", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({
          token,
          hwid:"" // sau này bạn có thể gửi HWID từ script Roblox
        })
      });

      const data = await res.json();
      if (!data.ok){
        loader.classList.add("done");
        keyBox.textContent = (data.code || "ERROR").toUpperCase();
        keyBox.classList.add("show");
        setMsg("error","system_error");
        setStatus("done");
        console.error("realkey error:", data);
        return;
      }

      const key = data.key;
      const expire = data.expire;

      keyBox.textContent = key;
      keyBox.classList.add("show");
      copyBtn.classList.add("show");

      if (data.reused) setMsg("ok","already_taken");
      else setMsg("ok","key_valid_24h");

      loader.classList.add("done");
      setStatus("done");

      function updateRemaining(){
        const left = expire - Date.now();
        timeLeftEl.textContent = formatRemaining(left);
      }
      updateRemaining();
      setInterval(updateRemaining,60*1000);

    }catch(e){
      console.error(e);
      loader.classList.add("done");
      keyBox.textContent = "ERROR";
      keyBox.classList.add("show");
      setMsg("error","system_error");
      setStatus("done");
    }
  }, 1200);
}

/* COPY KEY */
window.copyKey = function(){
  const key = document.getElementById("key").innerText.trim();
  if (!key || key==="..." || key==="ERROR" || key==="NO TOKEN") return;
  navigator.clipboard.writeText(key).then(()=>{
    const msg = document.getElementById("msg");
    msg.className = "msg show ok";
    msg.textContent = TEXT.copied[lang];
  });
};
</script>
